<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="js/math/math.js" type="text/javascript"></script>
    <link rel="stylesheet" href="css/main.css">
    <script type='text/javascript' src='x3dom/x3dom.js'> </script>
    <link rel='stylesheet' type='text/css' href='x3dom/x3dom.css'>
    <script>
        function show(i) {
            if(i>3||i<0) {alert("indexErr");return;}
            else {
                for(let j=0;j<3;j++){
                    if(j==i)document.getElementById("index_"+i).style.display="block";
                    else document.getElementById("index_"+j).style.display="none";
                }
            }
            if(i!=2)document.getElementById("demo").pause();
            else document.getElementById("demo").play();
            if(i!=3)document.getElementById("exm_video").pause();
            else document.getElementById("exm_video").play();
        }
    </script>
</head>
<body>
<div class="main-div" style="width: 1500px;">
    <div class="title"><b>机器人操作实验(型号：ABB_IRB120)</b></div>
    <div class="back" ><a href="index.html">←返回目录</a></div>
    <!--<button onclick="openTeachPendant()">打开虚拟示教器</button>-->
    <div id="index_div">
        <button class="InstBtn" onclick="show(0)">实验说明书</button><button class="InstBtn" onclick="show(2)">虚拟实验演示</button><button class="InstBtn" onclick="show(1)">开始实验</button><button class="InstBtn"  onclick="show(3)">实验操作视频</button>
    </div>
    <div id="index_0" style="width: 1500px;    margin-left: -750px;"> <embed id="instructTxt" src="pdf/ABBRobot.htm" ></embed></div>
    <div id="index_2"><video id="demo" src="video/demo/机器人.mp4" controls></video></div>
    <div id="index_3"><video id="exm_video" src="" controls></video></div>
    <div id="index_1" style="height: 800px">
        <div style="width: 80%;height: 100%;display: inline;float: left">
            <div id="robotX3d" style="width: 100%;height: 100%;">
            </div>
        </div>
        <div  style="width:20%;font: normal 15px Calibri;display: inline;float: left;text-align: center;background-color: #aaddff;height: 100%">
            <div class="message_div" id="messageDiv">
                <p>关节转角：</p><br>
                <p >Ang_1：<input id="angTxt0" type="text"  value="0" style="width: 50px" onchange="changeAngTxt(0)">
                    <input id="angInput0" type="range" max="165" min="-165" value="0" step="1" onchange="changeAng(0)">
                </p>
                <p>Ang_2：<input id="angTxt1" type="text" value="0" style="width: 50px" onchange="changeAngTxt(1)">
                    <input  id="angInput1" type="range" max="110" min="-110" value="0" step="1" onchange="changeAng(1)">
                </p>
                <p>Ang_3：<input id="angTxt2"  type="text"value="0" style="width: 50px"onchange="changeAngTxt(2)">
                    <input id="angInput2" type="range" max="70" min="-70" value="0" step="1" onchange="changeAng(2)">
                </p>
                <p>Ang_4：<input id="angTxt3"  type="text" value="0" style="width: 50px" onchange="changeAngTxt(3)">
                    <input id="angInput3" type="range" max="160" min="-160" value="0" step="1" onchange="changeAng(3)">
                </p>
                <p>Ang_5：<input id="angTxt4"  type="text"value="30" style="width: 50px" onchange="changeAngTxt(4)">
                    <input id="angInput4" type="range" max="120" min="-120" value="30" step="1" onchange="changeAng(4)">
                </p>
                <p>Ang_6：<input id="angTxt5"  type="text" value="0" style="width: 50px" onchange="changeAngTxt(5)">
                    <input id="angInput5" type="range" max="400" min="-400" value="0" step="1" onchange="changeAng(5)">
                </p>
                <p id="tool" style="padding-top: 4px">Tool :
                    <select onchange="instructionCompiling.changeTool(this.selectedIndex)" id="toolSelect" style="width:70px;font-size: 15px" >
                    <option value="0">tool0</option>
                    <option value="1">tool1</option>
                    </select>&nbsp;&nbsp;&nbsp;
                    Digital Output : <button id="setDO" type="button" style="width: 20px" onclick="instructionCompiling.setIO(!parseInt(this.innerText))" >0</button>
                </p>
            </div>
            <div class="message_div" id="resultDiv" onchange="changePos()">
                <div style="width: 50%;display: inline;float: left">
                    <p>末端坐标：</p><br>
                    <p>P_X：<input id="posX" type="text" value="364.35" class="robotPA"></p>
                    <p>P_Y：<input id="posY" type="text" value="0" class="robotPA"></p>
                    <p>P_Z：<input id="posZ" type="text" value="594" class="robotPA"></p>
                </div>
                <div style="width: 50%;display: inline;">
                    <p>末端姿态：</p><br>
                    <p>E_X：<input id="eulerX" type="text" value="-180" class="robotPA">°</p>
                    <p>E_Y：<input id="eulerY" type="text" value="60" class="robotPA">°</p>
                    <p>E_Z：<input id="eulerZ" type="text" value="-180" class="robotPA">°</p>
                </div>
            </div>
            <form id="myform" onsubmit="return PostData()" style="height: 100%;height: 100%">
                <div class="message_div" style="height: 23%;">
                    <p>设置示教点</p>
                    <textarea id="points" name="points" style="width: 90%;height: 66%;margin: 10px">
                    </textarea>
                    <div class="rowFlex-div">
                        <button type="button" id="add" onclick="changePoints(1)">添加</button>
                        <button type="button" id="delete" onclick="changePoints(2)">删除</button>
                        <button type="button" id="clear" onclick="changePoints(0)">清空</button>
                    </div>
                </div>
                <div class="message_div" style="height: 22%;">
                    <p>控制指令</p>
                    <textarea id="instrInput" name="instrInput" style="width: 80%;height: 60%;margin: 10px"></textarea><br>
                    <div class="rowFlex-div">
                        <button type="button"  onclick="changePoints(-1) ">示例程序</button><button type="button"   onclick="Instructions()">提交</button><button type="button" onclick="submitInstructions()">上传</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

</div>

<script src="js/VILibrary.js"></script>
<!--js简写方法-->
<script src="js/jquery-3.1.1.min.js"></script>
<!--弹出框-->
<script src="js/layui/lay/dest/layui.all.js"></script>
<script src="js/communication.js"></script>
<script>
    'use strict';
    let robot120VI = new VILibrary.VI.Robot120VI($('#robotX3d'), true);
    let instructionCompiling= new VILibrary.VI.Instruction_1VI($('#messageDiv'), true,"a120");
    let tool=new VILibrary.VI.ToolVI($('#tool'),true,"a120");
//    let kinematicsEquationVI= new VILibrary.VI.KinematicsEquationVI($('#resultDiv'), true);
    VILibrary.InnerObjects.bindDataLine(instructionCompiling.id, robot120VI.id, 1, 1);
    VILibrary.InnerObjects.bindDataLine(instructionCompiling.id, tool.id, 2, 1);
//    VILibrary.InnerObjects.bindDataLine(robot120VI.id, instructionCompiling.id, 1, 2);
//    VILibrary.InnerObjects.bindDataLine(instructionCompiling.id, kinematicsEquationVI.id, 5, 5);
    let val=[0],ang;
    let s=[],
        pAngle=[],
        pPos=[],
        indexI=0;
    let currentPOS=[364.35,0,594,-Math.PI,Math.PI/3,-Math.PI];
   /* if ("WebSocket" in window)
    {
        // 打开一个 web socket
        var ws = new WebSocket("ws://127.0.0.1:3002");

        ws.onopen = function()
        {
            // Web Socket 已连接上，使用 send() 方法发送数据
            ws.send("发送数据");
            console.log("数据发送中...");
        };

        ws.onmessage = function (evt)
        {
            var received_msg = evt.data;
            console.log("已接收数据",received_msg);
            if(received_msg=="go"){
                Instructions();
            }
            else console.log(received_msg)
        };

        ws.onclose = function()
        {
            // 关闭 websocket
            console.log("连接已关闭...");
        };
    }
    else
    {
        // 浏览器不支持 WebSocket
        alert("您的浏览器不支持 WebSocket!");
    }*/
   let wsServerAddr={
       port:'3002',
       host:'127.0.0.1'
   }
   let ws=new communcication(wsServerAddr);
   ws.connect();
   function submitInstructions() {
       let data=$('#myform').serialize();
       ws.send(data);
   }
    /*function PostData() {
        $.ajax({
            type: "POST",
            url: "/",
            data :$('#myform').serialize(),
            success: function(msg) {
            }
        });
//        Instructions();
        return false;
    }*/
    function changeAng(input) {
        let currentAng=[0,0,0,0,Math.PI/6,0];
        document.getElementById("angTxt"+input).value=document.getElementById("angInput"+input).value;
        for(let i=0;i<=5;i++){
            currentAng[i]=document.getElementById("angInput"+i).value/180*Math.PI;
        }
        instructionCompiling.moveJ(currentAng,500);
    }
    function changeAngTxt(input) {
        document.getElementById("angInput"+input).value=document.getElementById("angTxt"+input).value;
        changeAng(input);
    }
    function changePos() {
        let x=parseFloat(document.getElementById("posX").value),
            y=parseFloat(document.getElementById("posY").value),
            z=parseFloat(document.getElementById("posZ").value),
            gamma=parseFloat(document.getElementById("eulerX").value)/180*Math.PI,
            beta=parseFloat(document.getElementById("eulerY").value)/180*Math.PI,
            alpha=parseFloat(document.getElementById("eulerZ").value)/180*Math.PI;
            let pos=[x,y,z,gamma,beta,alpha];
        instructionCompiling.moveL(pos,100);
    }
    function Instructions() {
        instructionCompiling.toggleObserver(true);
    }
    function changePoints(type) {
        let turnPoints;
        switch (type){
            case 0:/*清空*/
                s=[];pAngle=[];indexI=0;pPos=[];
                /*----------------点集清空-------------------*/
                document.getElementById("Robot__PointSet_points").setAttribute('point','');
                /*-----------------------------------*/
                break;
            case 1:/*增加示教点*/
                let x=parseFloat(document.getElementById("posX").value),
                    y=parseFloat(document.getElementById("posY").value),
                    z=parseFloat(document.getElementById("posZ").value),
                    gamma=parseFloat(document.getElementById("eulerX").value),
                    beta=parseFloat(document.getElementById("eulerY").value),
                    alpha=parseFloat(document.getElementById("eulerZ").value);
                let si="p"+indexI+":["+x+","+y+","+z+","+gamma+"°,"
                    +beta+"°,"+alpha+"°];\n";
//                let piPos=[x,y,z,gamma/180*Math.PI,beta/180*Math.PI,alpha/180*Math.PI]
                let piPos=currentPOS.concat();
                s.push(si);
                let piAngle=[];
                for(let j=0;j<6;j++){
                    piAngle[j]= Number(document.getElementById("angTxt"+(j)).value)/180*Math.PI;
                }
                pAngle.push(piAngle);
                pPos.push(piPos);
                /*----------------点集增加点的坐标-------------------*/
                turnPoints=document.getElementById("Robot__PointSet_points").getAttribute('point');
                turnPoints=turnPoints+" "+x+" "+z+" "+(-y);
                document.getElementById("Robot__PointSet_points").setAttribute('point',turnPoints);
                /*-----------------------------------*/
                indexI++;
                break;
            case 2:/*删除示教点*/
                s.pop();
                pAngle.pop();
                pPos.pop();
                /*----------------点集删除最后一点的坐标-------------------*/
                turnPoints=document.getElementById("Robot__PointSet_points").getAttribute('point');
//                console.log(turnPoints.match(/\s-?\d+\.?\d*\s-?\d+\.?\d*\s-?\d+\.?\d*$/))
                turnPoints=turnPoints.replace(/\s-?\d+\.?\d*\s-?\d+\.?\d*\s-?\d+\.?\d*$/,'');
                document.getElementById("Robot__PointSet_points").setAttribute('point',turnPoints);
                /*-----------------------------------*/
                indexI--;
                break;
            case -1:
                /*
                s=["p0:[364.35,0,594,-180°,60°,-180°];\n","p1[464.35,0,594,-180°,60°,-180°];\n","p2:[467.54,0,371.09,180°,30°,-180°];\n","p3[346.62,0,225.29,180°,0°,-180°];\n"],
                pAngle=[[0, 0, 0, 0, 0.5235987755982988, 0],[0, 0.40282199136029123, -0.4750786223928564, -0, 0.5958554066308641, -0],[0, 0.5235987755982988, 0, 0, 0.5235987755982988, 0],[0, 0.5235987755982988, 0.5235987755982988, 0, 0.5235987755982988, 0]];
                    pPos=[[364.35, 0, 594, -3.141592653589793, 1.0471975511965976, -3.141592653589793],[464.35, 0, 594, -3.141592653589793, 1.0471848490249271, -3.141592653589793],[467.5397, 0, 371.0948, 3.141592653589793, 0.5236114777699694, -3.141592653589793],[346.6218, 0, 225.2872, 3.141592653589793, 0, -3.141592653589793]];
                document.getElementById("instrInput").value="moveJ p0,v500;\nmoveL p1,v200;\nmoveC p2,p3,v200;\nmoveJ p0,v500;";
                //------------------点集-------------------------
                turnPoints="364.35 594 0 464.35 594 0 467.54 371.09 0 346.62 225.29 0";
                document.getElementById("Robot__PointSet_points").setAttribute('point',turnPoints);
                //---------------------------------------------
                indexI=4;
                */
                s=["p0:[480.95,0,565.94,-180°,60°,-180°];\n","p1:[300,300,100,180°,0°,-180°];\n","p2:[300,300,20,180°,0°,-180°];\n","p3:[400,0,100,180°,0°,-180°];\n","p4:[400,0,20,180°,0°,-180°];\n"]
                pAngle=[[0, 0, 0, 0, 0.5235987755982988, 0],
                    [0.8454374896660531, 0.6958627727701391, 0.2769837522915001, 0, 0.5979498017332573, 0.8454374896660531],
                    [0.8454374896660531, 0.9161233243718235, 0.23596851486963336, 0, 0.41887902047863906, 0.8454374896660531],
                    [-0, 0.6030112565640408, 0.438601241026175, 0, 0.5291838292046808, -0],
                    [-0, 0.8422958970124633, 0.39671333897831107, 0, 0.33161255787892263, -0]];
                pPos=[[480.94675050769, 1.3045864533829317e-14, 565.944863728671, -3.141592653589793, 1.0471848490249271, -3.141592653589793],
                    [299.99999999999994, 300.00000000000006, 99.99999999999994, 3.141592653589793, -0, -3.141592653589793],
                    [300, 300.00000000000006, 20, 3.141592653589793, -0, -3.141592653589793],
                    [400.00000000000006, 4.157675883105265e-14, 99.99999999999994, 3.141592653589793, 0, -3.141592653589793],
                    [400, 4.6475346027642046e-14, 19.999999999999943, 3.141592653589793, 0, -3.141592653589793]];
                document.getElementById("instrInput").value="moveJ p0,v200;\nmoveJ p1,v200;\nmoveL p2,v200;\nset do1;\nmoveL p1,v200;\nmoveJ p3,v200;\nmoveL p4,v200;\nreset do1;\nmoveL p3,v200;\nmoveJ p0,v200;";
                turnPoints="480.95 565.94 0 300 100 -300 300 20 -300 400 100 0 400 20 0";
                document.getElementById("Robot__PointSet_points").setAttribute('point',turnPoints);
                indexI=5;
        }
        let str="";
        for(let m=0;m<indexI;m++){
            str= str + s[m] ;
        }
        document.getElementById("points").value=str;
    }
    /*function changeTool() {
        var  myselect=document.getElementById("toolSelect");
        var toolFlag=myselect.selectedIndex ;
        instructionCompiling.changeTool(toolFlag);
    }*/
    function openTeachPendant() {
        layer.open({
            type: 2,
            title: 'iframe父子操作',
            maxmin: true,
            shadeClose: true, //点击遮罩关闭层
            area : ['800px' , '520px'],
            content: 'teachPendant.html'
        });
    }

   /* let rob=document.getElementById('Robot');
    rob.onreadystatechange=function () {
    console.log(rob.readyState);
    }/!*document.getElementById('Robot')*!/document.body.onload=function(){
        $("#Robot__lastLink").after(toolSwitch);
        var tmp=$("#Robot__TOOL");
        console.log(tmp)}
    console.log('robot.x3d loaded')*/




</script>
</body>
</html>