<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="js/math/math.js" type="text/javascript"></script>
    <link rel="stylesheet" href="css/main.css">
    <script type='text/javascript' src='x3dom/x3dom.js'> </script>
    <link rel='stylesheet' type='text/css' href='x3dom/x3dom.css'>
    <script>
        function lightSwitch(id){
            var light = document.getElementById(id);
            if(light.getAttribute('on')!='TRUE')
                light.setAttribute('on','TRUE');
            else
                light.setAttribute('on','FALSE');
        }

        function headlight()
        {
            var h = document.getElementById("head");
            if(h.getAttribute('headlight')=='true')
                h.setAttribute('headlight', 'false');
            else
                h.setAttribute('headlight', 'true');
        }

    </script>
</head>
<body>
<div class="main-div" style="width: 1500px;">
    <div class="title"><b>机器人操作实验(型号：ABB_IRB120)</b></div>
    <div class="back" ><a href="index.html">←返回目录</a></div>
    <!--<button onclick="openTeachPendant()">打开虚拟示教器</button>-->
    <div id="index_1" style="height: 800px">
        <div style="width: 80%;height: 100%;display: inline;float: left">
            <div id="robotX3d" style="width: 100%;height: 100%;">
                <!--<x3d style="width: 100%;height: 100%;">
                    <scene>
                        <transform>
                            <inline nameSpaceName="Robot" mapDEFToID="true" url="assets/irb120_x3d/robot120.x3d"></inline>
                        </transform>
                    </scene>
                </x3d>-->
            </div>
            <div id="tools" >
                <input type="checkbox" checked="true" onclick="lightSwitch('point')">
                <label>point light</label>
                <input type="checkbox" checked="true" onclick="lightSwitch('spot')">
                <label>spot light</label>
                <input type="checkbox" checked="true" onclick="lightSwitch('directional')">
                <label>directional light</label>
                <input type="checkbox" checked="true" onclick="headlight()">
                <label>headlight</label>
            </div>
        </div>
        <div  style="width:20%;font: normal 15px Calibri;display: inline;float: left;text-align: center;background-color: #aaddff;height: 100%">
            <div class="message_div" id="messageDiv">
                <p>关节转角：</p><br>
                <p >Ang_1：<input id="angTxt0" type="text"  value="0" style="width: 50px" onchange="changeAngTxt(0)">
                    <input id="angInput0" type="range" max="165" min="-165" value="0" step="5" onchange="changeAng(0)">
                </p>
                <p>Ang_2：<input id="angTxt1" type="text" value="0" style="width: 50px" onchange="changeAngTxt(1)">
                    <input  id="angInput1" type="range" max="110" min="-110" value="0" step="5" onchange="changeAng(1)">
                </p>
                <p>Ang_3：<input id="angTxt2"  type="text"value="0" style="width: 50px"onchange="changeAngTxt(2)">
                    <input id="angInput2" type="range" max="70" min="-70" value="0" step="5" onchange="changeAng(2)">
                </p>
                <p>Ang_4：<input id="angTxt3"  type="text" value="0" style="width: 50px" onchange="changeAngTxt(3)">
                    <input id="angInput3" type="range" max="160" min="-160" value="0" step="5" onchange="changeAng(3)">
                </p>
                <p>Ang_5：<input id="angTxt4"  type="text"value="0" style="width: 50px" onchange="changeAngTxt(4)">
                    <input id="angInput4" type="range" max="120" min="-120" value="0" step="5" onchange="changeAng(4)">
                </p>
                <p>Ang_6：<input id="angTxt5"  type="text" value="0" style="width: 50px" onchange="changeAngTxt(5)">
                    <input id="angInput5" type="range" max="400" min="-400" value="0" step="5" onchange="changeAng(5)">
                </p>
            </div>
            <div class="message_div" id="resultDiv" onchange="changePos()">
                <div style="width: 50%;display: inline;float: left">
                    <p>末端坐标：</p><br>
                    <p>P_X：<input id="posX" type="text" value="374" class="robotPA"></p>
                    <p>P_Y：<input id="posY" type="text" value="0" class="robotPA"></p>
                    <p>P_Z：<input id="posZ" type="text" value="630" class="robotPA"></p>
                </div>
                <div style="width: 50%;display: inline;">
                    <p>末端姿态：</p><br>
                    <p>E_X：<input id="eulerX" type="text" value="0" class="robotPA">°</p>
                    <p>E_Y：<input id="eulerY" type="text" value="90" class="robotPA">°</p>
                    <p>E_Z：<input id="eulerZ" type="text" value="0" class="robotPA">°</p>
                </div>
            </div>
            <div class="message_div" style="height: 22%;">
                <p>设置示教点</p>
                <textarea id="points" style="width: 90%;height: 60%;margin: 10px">
                </textarea>
                <div class="rowFlex-div">
                    <button id="add" onclick="points(1)">添加</button>
                    <button id="delete" onclick="points(2)">删除</button>
                    <button id="clear" onclick="points(0)">清空</button>
                </div>
            </div>
            <div class="message_div" style="height: 22%;">
                <p>控制指令</p>
                <textarea id="instrInput" style="width: 80%;height: 60%;margin: 10px"></textarea><br>
                <div class="rowFlex-div">
                    <button  onclick="points(-1) ">示例程序</button><button   onclick="Instructions()">提交</button>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="js/VILibrary.js"></script>
<!--js简写方法-->
<script src="js/jquery-3.1.1.min.js"></script>
<!--弹出框-->
<script src="js/layui/lay/dest/layui.all.js"></script>
<script>
    'use strict';
    let robot120VI = new VILibrary.VI.Robot120VI($('#robotX3d'), true);
    let instructionCompiling= new VILibrary.VI.Instruction_1VI($('#messageDiv'), true);
//    let kinematicsEquationVI= new VILibrary.VI.KinematicsEquationVI($('#resultDiv'), true);
    VILibrary.InnerObjects.bindDataLine(instructionCompiling.id, robot120VI.id, 1, 2);
    VILibrary.InnerObjects.bindDataLine(robot120VI.id, instructionCompiling.id, 1, 2);

//    VILibrary.InnerObjects.bindDataLine(instructionCompiling.id, kinematicsEquationVI.id, 5, 5);
    let val=[0],ang;
    let s=[],
        pAngle=[],
        pPos=[],
        indexI=0;
    let currentPOS=[374,0,630,0,Math.PI/2,0];
    /*function changeTransparency() {
        if(document.getElementById('BASE__MA_Base_0').getAttribute('transparency')== '0'){
            for(let i=0;i<10;i++){
                document.getElementById('BASE__MA_Base_'+i).setAttribute('transparency', '0.1');
            }
        }
        else
            for(let i=0;i<10;i++){
                document.getElementById('BASE__MA_Base_'+i).setAttribute('transparency', '0');
            }
    }*/
    function changeAng(input) {
        let currentAng=[0,0,0,0,0,0];
        document.getElementById("angTxt"+input).value=document.getElementById("angInput"+input).value;
        for(let i=0;i<=5;i++){
            currentAng[i]=document.getElementById("angInput"+i).value/180*Math.PI;
        }
        instructionCompiling.moveJ(currentAng);
    }
    function changeAngTxt(input) {
        document.getElementById("angInput"+input).value=document.getElementById("angTxt"+input).value;
        changeAng(input);
    }
    function changePos() {
//        kinematicsEquationVI.setData([0,0,0,0,0,0],3)
        let x=parseFloat(document.getElementById("posX").value),
            y=parseFloat(document.getElementById("posY").value),
            z=parseFloat(document.getElementById("posZ").value),
            gamma=parseFloat(document.getElementById("eulerX").value)/180*Math.PI,
            beta=parseFloat(document.getElementById("eulerY").value)/180*Math.PI,
            alpha=parseFloat(document.getElementById("eulerZ").value)/180*Math.PI;
            /*ca=Math.cos(alpha),sa=Math.sin(alpha),
            cb=Math.cos(beta),sb=Math.sin(beta),
            cy=Math.cos(gamma),sy=Math.sin(gamma);
        let R=[[ca*cb,ca*sb*sy-sa*cy,ca*sb*cy+sa*sy,x],[sa*cb,sa*sb*sy+ca*cy,sa*sb*cy-ca*sy,y],[-sb,cb*sy,cb*cy,z],[0,0,0,1]];
        instructionCompiling.inverseKinematics(R);*/
            let pos=[x,y,z,gamma,beta,alpha];
        instructionCompiling.moveL(pos,100);

    }
    function Instructions() {
        instructionCompiling.toggleObserver(true);
    }
    function points(type) {
        let turnPoints;
        switch (type){
            case 0:/*清空*/
                s=[];pAngle=[];indexI=0;pPos=[];
                document.getElementById("Robot__PointSet_points").setAttribute('point','');
                break;
            case 1:/*增加示教点*/
                let x=parseFloat(document.getElementById("posX").value),
                    y=parseFloat(document.getElementById("posY").value),
                    z=parseFloat(document.getElementById("posZ").value),
                    gamma=parseFloat(document.getElementById("eulerX").value),
                    beta=parseFloat(document.getElementById("eulerY").value),
                    alpha=parseFloat(document.getElementById("eulerZ").value);
                let si="p"+indexI+": x"+x+" y"+y+" z"+z+" "+gamma+"° "
                    +beta+"° "+alpha+"°;\n";
//                let piPos=[x,y,z,gamma/180*Math.PI,beta/180*Math.PI,alpha/180*Math.PI]
                let piPos=currentPOS.concat();
                s.push(si);
                let piAngle=[];
                for(let j=0;j<6;j++){
                    piAngle[j]= Number(document.getElementById("angInput"+(j)).value)/180*Math.PI;
                }
                pAngle.push(piAngle);
                pPos.push(piPos);
                /*----------------点集增加点的坐标-------------------*/
                turnPoints=document.getElementById("Robot__PointSet_points").getAttribute('coord');
                turnPoints=turnPoints+" "+x+" "+z+" "+(-y);
                document.getElementById("Robot__PointSet_points").setAttribute('coord',turnPoints);
                /*-----------------------------------*/
                indexI++;
                break;
            case 2:/*删除示教点*/
                s.pop();
                pAngle.pop();
                pPos.pop();
                /*----------------点集删除最后一点的坐标-------------------*/
                turnPoints=document.getElementById("Robot__PointSet_points").getAttribute('point');
                console.log(turnPoints.match(/\s-?\d+\.?\d*\s-?\d+\.?\d*\s-?\d+\.?\d*$/))
                turnPoints=turnPoints.replace(/\s-?\d+\.?\d*\s-?\d+\.?\d*\s-?\d+\.?\d*$/,'');
                document.getElementById("Robot__PointSet_points").setAttribute('point',turnPoints);
                /*-----------------------------------*/
                indexI--;
                break;
            case -1:
                s=["p0: 340 0 302 0 0 0;\n","p1: -146.3 -39.2 75.7 0.0 -0.2 0.3;\n","p2: 136.5 36.6 93.3 0.0 0.9 0.3;\n"],
                    pAngle=[[0, 0, 0, 0, 0, 0],[-2.8797932657906435, -1.0471975511965976, 1.2217304763960306, 0, 0, 0],[-2.8797932657906435, 1.0471975511965976, 1.2217304763960306, 0, 0, 0]];
                document.getElementById("instrInput").value="moveJ p0;\nmoveJ p1;\nmoveJ p2;\nmoveJ p1;\nmoveJ p2;\nmoveJ p0;";
                indexI=3;
        }
        let str="";
        for(let m=0;m<indexI;m++){
            str= str + s[m] ;
        }
        document.getElementById("points").value=str;
    }
    function openTeachPendant() {
        layer.open({
            type: 2,
            title: 'iframe父子操作',
            maxmin: true,
            shadeClose: true, //点击遮罩关闭层
            area : ['800px' , '520px'],
            content: 'teachPendant.html'
        });

    }



</script>
</body>
</html>